"use strict";(self["webpackChunkfullstack_ecommerce_pojui"]=self["webpackChunkfullstack_ecommerce_pojui"]||[]).push([[309],{8965:function(t,e,a){a.d(e,{PW:function(){return c},db:function(){return o},j2:function(){return n}});var r=a(223),s=a(1601),d=a(1884);const l={apiKey:"AIzaSyA9DPx8_HE6nrr3Ur84EcVp1UvIM7Tmsyg",authDomain:"ecommerce-user-e27fa.firebaseapp.com",projectId:"ecommerce-user-e27fa",storageBucket:"ecommerce-user-e27fa.appspot.com",messagingSenderId:"963949372026",appId:"1:963949372026:web:8c37ee1e37682669b091c3",measurementId:"G-XC0ZSW2MQP"},i=(0,r.Wp)(l),n=(0,s.xI)(i),o=(0,d.aU)(i),c=new s.HF;new s.sk},309:function(t,e,a){a.r(e),a.d(e,{default:function(){return gt}});var r=a(641),s=a(2644),d=a(9322);const l=t=>((0,r.Qi)("data-v-a3b2c378"),t=t(),(0,r.jt)(),t),i=l((()=>(0,r.Lk)("i",{class:"fas fa-spinner fa-spin fa-5x"},null,-1))),n={class:"table mt-4"},o=l((()=>(0,r.Lk)("thead",{class:"table-dark"},[(0,r.Lk)("tr",null,[(0,r.Lk)("th",null,"購買時間"),(0,r.Lk)("th",{class:"email"},"Email"),(0,r.Lk)("th",null,"訂單編號"),(0,r.Lk)("th",{class:"cartTotal"},"應付金額"),(0,r.Lk)("th",{class:"is_paid"},"是否付款"),(0,r.Lk)("th",null,"編輯")])],-1))),c={class:"email"},u=["textContent"],p=["textContent"],h={class:"cartTotal text-left"},m={class:"is_paid"},k={class:"form-check form-switch"},L=["id","onUpdate:modelValue","onChange"],b=["for"],f={key:0,class:"text-success"},g={key:1,class:"text-danger"},_={class:"btn-group"},v=["onClick"],O=["onClick"];function y(t,e,a,l,y,C){const w=(0,r.g2)("Loading"),x=(0,r.g2)("OrderModal"),E=(0,r.g2)("Pagination");return(0,r.uX)(),(0,r.CE)(r.FK,null,[(0,r.bF)(w,{active:y.isLoading},{default:(0,r.k6)((()=>[i])),_:1},8,["active"]),(0,r.Lk)("table",n,[o,(0,r.Lk)("tbody",null,[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(y.ordersData,((e,a)=>((0,r.uX)(),(0,r.CE)(r.FK,{key:a},[y.orders.length?((0,r.uX)(),(0,r.CE)("tr",{key:0,class:(0,s.C4)({"text-secondary":!e.is_paid})},[(0,r.Lk)("td",null,(0,s.v_)(t.$filters.date(e.create_at)),1),(0,r.Lk)("td",c,[e.user?((0,r.uX)(),(0,r.CE)("span",{key:0,textContent:(0,s.v_)(e.user.email)},null,8,u)):(0,r.Q3)("",!0)]),(0,r.Lk)("td",null,[e?((0,r.uX)(),(0,r.CE)("span",{key:0,textContent:(0,s.v_)(e.id)},null,8,p)):(0,r.Q3)("",!0)]),(0,r.Lk)("td",h,(0,s.v_)(t.$filters.currency(e.cartTotal)),1),(0,r.Lk)("td",m,[(0,r.Lk)("div",k,[(0,r.bo)((0,r.Lk)("input",{class:"form-check-input",type:"checkbox",id:`paidSwitch${e.id}`,"onUpdate:modelValue":t=>e.is_paid=t,onChange:t=>C.updatePaid(e)},null,40,L),[[d.lH,e.is_paid]]),(0,r.Lk)("label",{class:"form-check-label",for:`paidSwitch${e.id}`},[e.is_paid?((0,r.uX)(),(0,r.CE)("span",f,"已付款")):((0,r.uX)(),(0,r.CE)("span",g,"未付款"))],8,b)])]),(0,r.Lk)("td",null,[(0,r.Lk)("div",_,[(0,r.Lk)("button",{class:"btn btn-outline-primary btn-sm",onClick:t=>C.openModal(!1,e)}," 檢視 ",8,v),(0,r.Lk)("button",{class:"btn btn-outline-danger btn-sm",onClick:t=>C.openDelOrderModal(e)}," 刪除 ",8,O)])])],2)):(0,r.Q3)("",!0)],64)))),128))])]),(0,r.bF)(x,{order:y.tempOrder,ref:"orderModal",onUpdateOrder:C.updateOrder},null,8,["order","onUpdateOrder"]),(0,r.bF)(E,{pages:y.pagination,onEmitPages:C.getOrders},null,8,["pages","onEmitPages"])],64)}const C=t=>((0,r.Qi)("data-v-9a31fac6"),t=t(),(0,r.jt)(),t),w={class:"modal fade",id:"productModal",tabindex:"-1",role:"dialog","aria-labelledby":"exampleModalLabel","aria-hidden":"true",ref:"modal"},x={class:"modal-dialog modal-xl",role:"document"},E={class:"modal-content border-0"},D=C((()=>(0,r.Lk)("div",{class:"modal-header bg-dark text-white"},[(0,r.Lk)("h5",{class:"modal-title",id:"exampleModalLabel"},[(0,r.Lk)("span",null,"訂單細節")]),(0,r.Lk)("button",{type:"button",class:"btn-close btn-close-white","data-bs-dismiss":"modal","aria-label":"Close"})],-1))),$={class:"modal-body"},I={class:"row"},X={class:"user col-5"},M=C((()=>(0,r.Lk)("h3",{class:"inner-modal-title"},"◎ 用戶資料 ◎",-1))),P={class:"table"},T={key:0},j=C((()=>(0,r.Lk)("th",{style:{width:"100px"}},"姓名",-1))),A=C((()=>(0,r.Lk)("th",null,"Email",-1))),B=C((()=>(0,r.Lk)("th",null,"電話",-1))),F=C((()=>(0,r.Lk)("th",null,"地址",-1))),U={class:"order col-7"},G=C((()=>(0,r.Lk)("h3",{class:"inner-modal-title"},"◎ 訂單細節 ◎",-1))),H={class:"table"},Q=C((()=>(0,r.Lk)("th",{style:{width:"100px"}},"訂單編號",-1))),S=C((()=>(0,r.Lk)("th",null,"下單時間",-1))),K=C((()=>(0,r.Lk)("th",null,"付款時間",-1))),Z={key:0},z={key:1,class:"text-warning"},J=C((()=>(0,r.Lk)("th",null,"付款狀態",-1))),V={key:0,class:"text-success"},W={key:1,class:"text-danger"},N=C((()=>(0,r.Lk)("th",null,"優惠券",-1))),q={key:0,class:"text-success"},R={key:1,class:"text-danger"},Y=C((()=>(0,r.Lk)("th",null,"總金額",-1))),tt=C((()=>(0,r.Lk)("th",null,"留言",-1))),et=C((()=>(0,r.Lk)("h3",{class:"inner-modal-title"},"◎ 選購商品 ◎",-1))),at={class:"table"},rt=C((()=>(0,r.Lk)("thead",null,[(0,r.Lk)("tr")],-1))),st={class:"text-end"},dt={class:"modal-footer"},lt=C((()=>(0,r.Lk)("button",{type:"button",class:"btn btn-outline-secondary","data-bs-dismiss":"modal"}," 取消 ",-1)));function it(t,e,a,d,l,i){return(0,r.uX)(),(0,r.CE)("div",w,[(0,r.Lk)("div",x,[(0,r.Lk)("div",E,[D,(0,r.Lk)("div",$,[(0,r.Lk)("div",I,[(0,r.Lk)("div",X,[M,(0,r.Lk)("table",P,[l.tempOrder.user?((0,r.uX)(),(0,r.CE)("tbody",T,[(0,r.Lk)("tr",null,[j,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.user.name),1)]),(0,r.Lk)("tr",null,[A,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.user.email),1)]),(0,r.Lk)("tr",null,[B,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.user.tel),1)]),(0,r.Lk)("tr",null,[F,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.user.address),1)])])):(0,r.Q3)("",!0)])]),(0,r.Lk)("div",U,[G,(0,r.Lk)("table",H,[(0,r.Lk)("tbody",null,[(0,r.Lk)("tr",null,[Q,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.id),1)]),(0,r.Lk)("tr",null,[S,(0,r.Lk)("td",null,(0,s.v_)(t.$filters.date(l.tempOrder.create_at))+" "+(0,s.v_)(l.createDateDetail),1)]),(0,r.Lk)("tr",null,[K,(0,r.Lk)("td",null,[""!==l.tempOrder.paid_date&&!0===l.tempOrder.is_paid?((0,r.uX)(),(0,r.CE)("span",Z,(0,s.v_)(t.$filters.date(l.tempOrder.paid_date))+" "+(0,s.v_)(l.paidDateDetail),1)):((0,r.uX)(),(0,r.CE)("span",z,"時間不正確"))])]),(0,r.Lk)("tr",null,[J,(0,r.Lk)("td",null,[l.tempOrder.is_paid?((0,r.uX)(),(0,r.CE)("strong",V,"已付款")):((0,r.uX)(),(0,r.CE)("span",W,"尚未付款"))])]),(0,r.Lk)("tr",null,[N,(0,r.Lk)("td",null,[!0===l.tempOrder.isCouponUsed?((0,r.uX)(),(0,r.CE)("strong",q,(0,s.v_)(l.tempOrder.products[0].coupon.title),1)):((0,r.uX)(),(0,r.CE)("span",R,"無"))])]),(0,r.Lk)("tr",null,[Y,(0,r.Lk)("td",null,(0,s.v_)(t.$filters.currency(l.tempOrder.cartTotal)),1)]),(0,r.Lk)("tr",null,[tt,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.message),1)])])]),et,(0,r.Lk)("table",at,[rt,(0,r.Lk)("tbody",null,[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(l.tempOrder.products,(e=>((0,r.uX)(),(0,r.CE)("tr",{key:e.id},[(0,r.Lk)("th",null,"● "+(0,s.v_)(e.product.title),1),(0,r.Lk)("td",null,(0,s.v_)(e.qty)+" / "+(0,s.v_)(e.product.unit),1),(0,r.Lk)("td",st,(0,s.v_)(t.$filters.currency(e.final_total)),1)])))),128))])])])])]),(0,r.Lk)("div",dt,[(0,r.Lk)("button",{type:"button",class:"btn btn-primary","data-bs-dismiss":"modal",onClick:e[0]||(e[0]=e=>t.$emit("update-order",l.tempOrder))}," 確認 "),lt])])])],512)}var nt=a(3286),ot={name:"orderModal",props:{order:{type:Object,default(){return{}}}},data(){return{status:{},modal:"",tempOrder:{},isPaid:!1,createDateDetail:"",paidDateDetail:""}},mixins:[nt.A],inject:["emitter"],watch:{order(){this.tempOrder=this.order,this.isPaid=this.tempOrder.is_paid,this.createDateDetail=this.formatTimestamp(this.tempOrder.create_at),this.paidDateDetail=this.formatTimestamp(this.tempOrder.paid_date)}},methods:{formatTimestamp(t){const e=new Date(1e3*t);return e.toLocaleTimeString()}}},ct=a(6262);const ut=(0,ct.A)(ot,[["render",it],["__scopeId","data-v-9a31fac6"]]);var pt=ut,ht=a(8285),mt=a(8965),kt=a(2541),Lt=a(1884),bt={data(){return{orders:{},isNew:!1,pagination:{},isLoading:!1,tempOrder:{},currentPage:1,ordersData:{},token:document.cookie.replace(/(?:(?:^|.*;\s*)customToken\s*=\s*([^;]*).*$)|^.*$/,"$1")}},components:{Pagination:ht.A,OrderModal:pt},methods:{updateOrder(t){console.log(t)},async getOrders(t=1){this.currentPage=t;const e=`https://fullstack-ecommerce-pojui-backend-vercel.vercel.app/admin/orders?page=${t}`;this.isLoading=!0,this.$http.get(e,{headers:{Authorization:`Bearer ${this.token}`}}).then((t=>{this.orders=t.data.orders,this.pagination=t.data.pagination,this.isLoading=!1})).catch((()=>{kt.A.fire({icon:"error",title:"您尚未登入，若要進行後台管理請重新登入!"}),setTimeout((()=>{this.$router.push("/login")}),500)}));try{const e=(0,Lt.rJ)(mt.db,"orderInfo"),a=await(0,Lt.GG)(e),r=[];for(const t of a.docs){const e={id:t.id,...t.data()},a=(0,Lt.rJ)(t.ref,"cartInfo"),s=await(0,Lt.GG)(a),d=[];s.forEach((t=>{d.push({id:t.id,...t.data()})})),e.products=d,r.push(e)}this.ordersData=r;let s=t||1;const d=10,l=this.ordersData.length,i=Math.ceil(l/d);l<d&&(s=1,this.currentPage=s),s=Math.max(1,Math.min(s,i));const n=(s-1)*d,o=n+d;this.ordersData=this.ordersData.sort(((t,e)=>e.create_at-t.create_at));const c=this.ordersData.slice(n,o);this.ordersData=c}catch(a){console.error("Error fetching orders with subcollections: ",a)}},openModal(t,e){this.tempOrder={...e},this.isNew=!1;const a=this.$refs.orderModal;a.showModal()},openDelOrderModal(t){this.tempOrder={...t},this.$swal({title:"確定要刪除?",html:'是否刪除<b class="text-danger"></b>(刪除後將無法恢復)',icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"是, 確定刪除!",cancelButtonText:"取消"}).then((e=>{e.isConfirmed&&(this.$swal("已刪除!","檔案已被刪除","success"),this.delOrder(t.id))}))},async updatePaid(t){const e=(0,Lt.H9)(mt.db,"orderInfo",t.id);let a="";this.ordersData.forEach((e=>{e.id===t.id&&!0===e.is_member&&(a=(0,Lt.H9)(mt.db,"userInfo",e.uid))}));const r=await(0,Lt.x7)(a),s=r.data();""!==a&&(s.orders.forEach((e=>{e.orderId===t.id&&(e.is_paid=t.is_paid,!1===t.is_paid&&(e.paid_date=""))})),await(0,Lt.mZ)(a,{orders:s.orders})),!1===t.is_paid&&await(0,Lt.mZ)(e,{paid_date:""}),await(0,Lt.mZ)(e,{is_paid:t.is_paid}),this.isLoading=!0;const d=`https://fullstack-ecommerce-pojui-backend-vercel.vercel.app/admin/order/${t.id}`,l={is_paid:t.is_paid};this.$http.put(d,{data:l},{headers:{Authorization:`Bearer ${this.token}`}}).then((t=>{this.isLoading=!1,kt.A.fire({icon:"success",title:"付款狀態已更新"}),this.getOrders(this.currentPage)})).catch((t=>{this.isLoading=!1,console.log(t)}))},async delOrder(t){const e=`https://fullstack-ecommerce-pojui-backend-vercel.vercel.app/admin/order/${this.tempOrder.id}`;this.isLoading=!0;const a=(0,Lt.H9)(mt.db,"orderInfo",t);let r="";this.ordersData.forEach((e=>{e.id===t&&!0===e.is_member&&(r=(0,Lt.H9)(mt.db,"userInfo",e.uid))}));const s=await(0,Lt.x7)(r),d=s.data().orders;d.forEach((e=>{e.orderId===t&&d.splice(d.indexOf(e),1)})),await(0,Lt.mZ)(r,{orders:d});const l=(0,Lt.rJ)(a,"cartInfo"),i=await(0,Lt.GG)(l);i.forEach((async t=>{await(0,Lt.kd)(t.ref)})),await(0,Lt.kd)(a),this.$http.delete(e,{headers:{Authorization:`Bearer ${this.token}`}}).then((t=>{this.getOrders(this.currentPage)}))}},created(){this.getOrders(),this.$emitter.emit("check-navbar","orders")}};const ft=(0,ct.A)(bt,[["render",y],["__scopeId","data-v-a3b2c378"]]);var gt=ft}}]);
//# sourceMappingURL=309.61f5531c.js.map